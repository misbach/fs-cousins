<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>

<p style="text-align: center;">Tita's surnames are blue in the map below. Enter your surname and they will show up in red.</p>
<div class="form-row justify-content-center">
	<div class="col-auto">
		<input type="text" class="form-control mb-2 name">
	</div>
	<div class="col-auto">
		<button type="submit" class="btn btn-primary mb-2 search">Search</button>
	</div>
</div>

<div class="results">
	<div class="countries" style="display: none; margin-top: 50px; margin-bottom: 50px;">
		<p class="countryDesc" style="font-size: 30px; text-align: center; margin-bottom: 30px;">Your surname was found <span class="totalCount"></span> times in the following countries.</p>
		<ul class="countryList" style="display: flex; list-style: none; text-align: center; justify-content: center;"></ul>
	</div>
	<div id="mapid" style="height: 450px;"></div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="https://codepen.io/misbach/pen/doCKx.js"></script>
<script type="text/javascript">
// Create map
var map = L.map('mapid', {preferCanvas: true}).setView([15, 0], 2);
L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
	maxZoom: 18,
	id: 'mapbox.streets',
	accessToken: 'pk.eyJ1IjoibWlzYmFjaCIsImEiOiJjamZpcnZ0bXUwMHpyMzNwZmw3NzlzaGR1In0.I5SDAbWV7lnkaK_jCPNLQQ'
}).addTo(map);
let token = null;

// Populate map with pins
for (let i = 0; i < people.length; i++) {
	// let portrait = 'https://api.familysearch.org/platform/tree/persons/'+people[i].pid+'/portrait?access_token='+token+'&default=https://www.familysearch.org/frontier/styleguide/icons/assets/icons/familysearch-account-xl.svg';
	let portrait = "https://www.familysearch.org/frontier/styleguide/icons/assets/icons/familysearch-account-xl.svg";
	L.circleMarker([people[i].lat, people[i].lon], {color: '#6860ec', radius: 5}).addTo(map).bindPopup('<a href="https://ancestors.familysearch.org/en/'+people[i].pid+'" target="_blank"><img width="64" src="'+portrait+'"><br />'+people[i].name+'<br />'+people[i].lifespan+'</a>');
}

// Name Search
$('.search').click(function() {
	// Get tree results
	let name = $('.name').val();
	fetch("https://strategicsolutions.herokuapp.com/homelands/search?name="+name, {method: "get"})
	.then(function(rsp) { return rsp.json() })
	.then(function(obj) {
		token = obj.token;
		for (var i = 0; i < obj.entries.length; i++) {
		let person = obj.entries[i].content.gedcomx.persons[0];
		if (person.display.birthPlace) {
			// Get lat/lon
			let url = "https://api.familysearch.org/platform/places/search?q=name:"+encodeURI(person.display.birthPlace)+"&count=1";
			console.log(url);
			fetch(url, {
				headers: { Authorization: "Bearer "+obj.token, Accept: "application/json"}
			})
			.then(function(rsp) { return rsp.json() })
			.then(function(obj) {
				let lat = obj.entries[0].content.gedcomx.places[0].latitude;
				let lon = obj.entries[0].content.gedcomx.places[0].longitude;
				// Place push-pin
				if (lat) {
					let portrait = 'https://api.familysearch.org/platform/tree/persons/'+person.id+'/portrait?access_token='+token+'&default=https://www.familysearch.org/frontier/styleguide/icons/assets/icons/familysearch-account-xl.svg';
					let birth = (person.display.birthDate) ? person.display.birthDate : "";
					L.circleMarker([lat, lon], {color: '#e86666', radius: 5}).addTo(map).bindPopup('<a href="https://ancestors.familysearch.org/en/'+person.id+'" target="_blank"><img width="64" src="'+portrait+'"><br />'+person.display.name+'<br />'+birth+'</a>');
				}
			});
		}
		}

		// Get Discovery Name info
		fetch("https://www.familysearch.org/service/discovery/allaboutme/treesurnamecount/"+name, {method: "get", headers: { "Authorization": "Bearer "+obj.token}})
		.then(function(rsp) { return rsp.json() })
		.then(function(obj) {
			$('.countries').show();
			$('.countryList').empty();
			$('.totalCount').text(obj.totalCount.toLocaleString()+" times ");
			for (let i = 0; i < obj.countries.length; i++) {
			const name = obj.countries[i].name;
			const count = obj.countries[i].count.toLocaleString();
			let code = obj.countries[i].code.toLowerCase();
			if (code == "eng") code = "gbr";
			if (code == "sct") code = "gbr";
			if (code == "wal") code = "gbr";
			if (code == "usa") continue; // Skip USA
			$('.countryList').append('<li class="country" style="width: 150px;"><a href="https://en.wikipedia.org/wiki/'+name+'" target="_blank"><img class="countryMap" src="https://restcountries.eu/data/'+code+'.svg" style="height: 70px;"></a><br />'+name+'<br /><span class="count">'+count+'</span></li>')
			}
		});
		
	});
});

// Search on Enter key
$('.name').keypress(function(e) { if (e.which == 13) { $('.search').click() } });
</script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

<center>
	<div class="form-row justify-content-center">
		<div class="col-auto">
			<input type="text" class="form-control mb-2 name">
		</div>
		<div class="col-auto">
			<button type="submit" class="btn btn-primary mb-2 search">Search</button>
		</div>
	</div>

	<style>.countryMap { height: 80px; margin-right: 30px; }</style>
	<div class="info" style="display: none;">Você e o Tita estão conectados! Vocês compartilham sobrenomes dos mesmos países. Selecione uma bandeira e compartilhe o seu meme.</div>
	<ul class="flags" style="margin-top: 30px; display: flex; list-style: none; text-align: center; justify-content: center;"></ul>

	<p>
		<button style="display: none;" class="btn btn-primary download" onclick="download();">Download Image</button>
	</p>
	<canvas  width="650" height="650" id="canvas"></canvas>
</center>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript">
	// Name Search
	$('.search').click(function() {
		$('.flags').empty();
		$('.info').hide();
		$('.download').hide();

		// Get tree results
		let name = $('.name').val();
		fetch("https://strategicsolutions.herokuapp.com/homelands/search?name="+name, {method: "get"})
		.then(function(rsp) { return rsp.json() })
		.then(function(obj) {
			token = obj.token;

			// Get Discovery Name info
			fetch("https://www.familysearch.org/service/discovery/allaboutme/treesurnamecount/"+name, {method: "get", headers: { "Authorization": "Bearer "+obj.token}})
			.then(function(rsp) { return rsp.json() })
			.then(function(obj) {
				let countries = [
					{ "code": "prt", "flag": "https://upload.wikimedia.org/wikipedia/commons/5/5c/Flag_of_Portugal.svg" },
					{ "code": "mex", "flag": "https://upload.wikimedia.org/wikipedia/commons/f/fc/Flag_of_Mexico.svg" },
					{ "code": "ecu", "flag": "https://upload.wikimedia.org/wikipedia/commons/e/e8/Flag_of_Ecuador.svg" },
					{ "code": "ury", "flag": "https://upload.wikimedia.org/wikipedia/commons/f/fe/Flag_of_Uruguay.svg" },
					{ "code": "ago", "flag": "https://upload.wikimedia.org/wikipedia/commons/9/9d/Flag_of_Angola.svg" },
					{ "code": "esp", "flag": "https://upload.wikimedia.org/wikipedia/en/9/9a/Flag_of_Spain.svg" },
					{ "code": "lbn", "flag": "https://upload.wikimedia.org/wikipedia/commons/5/59/Flag_of_Lebanon.svg" },
					{ "code": "ven", "flag": "https://upload.wikimedia.org/wikipedia/commons/7/7b/Flag_of_Venezuela_%28state%29.svg" },
					{ "code": "arg", "flag": "https://upload.wikimedia.org/wikipedia/commons/1/1a/Flag_of_Argentina.svg" }
				];
				$('.countries').show();
				$('.countryList').empty();
				$('.totalCount').text(obj.totalCount.toLocaleString()+" times ");
				// Iterate country codes
				let flag = null;
				let homeland = null;
				for (let i = 0; i < obj.countries.length; i++) {
					let name = obj.countries[i].name;
					let code = obj.countries[i].code.toLowerCase();
					for (let j = 0; j < countries.length; j++) {
						if (code == countries[j].code) {
							// Get the first country name and flag
							if (!flag) { homeland = name; flag = countries[j].flag; }

							// Display flags
							$('.flags').append('<li class="country" data-meta="'+name+'|'+countries[j].flag+'"><img class="countryMap" src="https://restcountries.eu/data/'+code+'.svg"><br />'+name+'</li>')
						}
					}
				}
				if (flag) {
					shareImg(homeland, flag);
				} else {
					alert("Infelizmente este sobrenome não compartilha dos mesmos países que o do Tita.");
				}
			});
		});
	});

	// customize flag on sharable
	$(document.body).on('click', '.country' ,function() {
		let data = $(this).data('meta').split("|");
		shareImg(data[0], data[1]);
	});

	// Generate sharable image
	function shareImg(name, flag) {
		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");
		// var img1 = loadImage("https://upload.wikimedia.org/wikipedia/commons/5/5c/Flag_of_Portugal.svg", main);
		var img1 = loadImage(flag, main);
		var img2 = loadImage('https://i.ibb.co/1TD7LZ6/Tita1650.png', main);
		var imagesLoaded = 0;
		function main() {
			imagesLoaded += 1;
			if(imagesLoaded == 2) {
				ctx.drawImage(img2, 0, 0);
				ctx.drawImage(img1, 400, 140, 200, 200 * img1.height / img1.width );
				ctx.font = "30px Verdana";
				ctx.fillStyle = "white";
				ctx.textAlign = "center";
				ctx.fillText("Tita and "+$('.name').val(), 325, 40);
				ctx.fillText("Share the same ancestral homeland", 325, 85);
				ctx.fillText(name, 500, 305);
			}
		}
		$('.download').show();
		$('.info').show();
	}

	// Load Image
	function loadImage(src, onload) {
		var img = new Image();
		img.onload = onload;
		img.crossOrigin = "anonymous";
		img.src = src;
		return img;
	}

	function download() {
		var link = document.createElement('a');
		link.download = 'tita.png';
		link.href = document.getElementById("canvas").toDataURL();
		link.click();
	}

	// Search on Enter key
	$('.name').keypress(function(e) { if (e.which == 13) { $('.search').click() } });
</script>
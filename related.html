<p>Hi! We’re the Yeagers. You may know us from our YouTube channel, Shot of the Yeagers. There are a total of eight of us in the SOTY family—two parents, five daughters, and one son—but we know our family is much bigger than that.</p>
<p>In fact, it’s very possible that many of you are family! We’ve partnered with FamilySearch so we can see just how big our family is. Use this page to see if you might be a Yeager cousin!</p>
<p>To see if we are related, either sign-in to your FamilySearch account or create one—don’t worry, it’s absolutely free! If you are just starting with FamilySearch, we recommend you <a href="https://www.familysearch.org/blog/en/how-to-start-a-family-tree/" target="_blank">fill out at least 4 generations on your family tree.</a></p>
<p>FamilySearch will look at the <a href="https://www.familysearch.org/blog/en/online-family-tree/" target="_blank">shared Family Tree</a> to see if we have a <a href="https://www.familysearch.org/blog/en/cousin-chart/" target="_blank">common grandparent</a>, so the more information you add to the Family Tree, the more likely it will show we are related.</p>
<p>Once you have your family tree set up, just click on the button below!</p>

<center>
    <button class="btn areyou" onclick="fs.oauthRedirect()">Are you related to the Yeagers?</button>
    <br />

    <div class="steve" style="display: none;">
        <h2>You are a cousin to Steve!</h2>
        <p>Click <a href="" target="_blank" class="primaryLink">here</a> to see our shared relative</p>
        <img src="https://i.ibb.co/JmbQ5Vh/steve.jpg" style="border-radius: 50%; border-style: solid; border-width: 3px;">
        <p style="margin-top: 50px;">Below is a graphic for you to share on Instagram #SOTYFam.</p>
    </div>
    <div class="jamie" style="display: none;">
        <h2>You are a cousin to Jamie!</h2>
        <p>Click <a href="" target="_blank" class="primaryLink">here</a> to see our shared relative</p>
        <img src="https://i.ibb.co/fCPB7y0/jamie.jpg" style="border-radius: 50%; border-style: solid; border-width: 3px;">
        <p style="margin-top: 50px;">Below is a graphic for you to share on Instagram #SOTYFam.</p>
    </div>

    <canvas width="650" height="650" id="canvas" style="display: none;"></canvas>
    <br />
    <button style="margin-top: 15px; margin-bottom: 15px; display: none;" class="btn btn-primary download" onclick="download();">Download Image</button>
</center>

<div class="notFound" style="display: none;">
    <h3>No relationship found</h3>
    <p>Want to try again? Use the <a href="https://www.familysearch.org/blog/en/relatives/">Relatives around Me</a> feature on the FamilySearch mobile app to see if you and a friend are related—any time, anywhere.</p>
    <p>Note: If you have few people in your family tree on FamilySearch, you may need to add more before you can find cousin connections. See this post on <a href="https://www.familysearch.org/blog/en/getting-started-shared-family-tree/">Connecting to the FamilySearch Shared Tree</a> for tips on adding relatives and filling out your family tree.</p>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://unpkg.com/fs-js-lite@2.x/dist/FamilySearch.min.js"></script>
<script>
    let IDs = ["KWZM-M19","KWC6-SVK","KWC6-SVG","KWC6-SV8","245X-G1Z","2H2N-9BL","2HK1-C11"];
    let fs = new FamilySearch({
        environment: 'production',
        appKey: 'a02j000000KTRjpAAH',
        // redirectUri: 'https://beta.familysearch.org/en/blog/?p=47620',
        // redirectUri: 'https://www.familysearch.org/blog/en/yeagers-soty-family/',
        redirectUri: 'http://localhost:5000/related.html',
        saveAccessToken: true,
        tokenCookie: 'FS_AUTH_TOKEN'
    });

    // Auto-login: Handle an OAuth2 state
    var oauthResponseState = fs.oauthResponse(function(error, response) { });

    // Login if not authenticated
    fs.oauthResponse(function() {
        fs.get("/platform/users/current", function(error, response) {
            if (response.statusCode == 401) fs.oauthRedirect();
            fs.user = response.data.users[0];

            // Get Relationships
            let people = [];
            let promises = [];
            (async () => {
                for (let i = 0; i < IDs.length; i++) {
                    let person = { id: IDs[i] };
                    let url = "https://www.familysearch.org/service/tree/tree-data/my-relatives/tree-graph-relation/"+fs.user.personId+"/"+IDs[i]+"?showApexCoParentEx=true";
                    promises.push(fetch(url, { headers: { 'Authorization': 'Bearer ' + fs.accessToken } })
                    .then((resp) => resp.json())
                    .then(function (rsp) {
                        if (rsp.status == 204) return;
                        if (rsp.data.persons.length == 0) return;
                        console.log(rsp);
                        person.path = rsp.data.persons;
                        person.name = rsp.data.persons[rsp.data.persons.length-1].name;
                        person.lifespan = rsp.data.persons[rsp.data.persons.length-1].lifespan;
                        person.relationship = rsp.data.relationType;
                        people.push(person);
                    }));
                }
                await Promise.all(promises);
                display(people);
            })();
        });
    });

    // Display closest relative
    function display(relationships) {
        if (relationships.length == 0) {
            console.log(relationships);
            $('.notFound').show();
            return
        }
        
        // Find shortest one
        let relative = relationships[0];
        for (let i = 0; i < relationships.length; i++) {
            if (relationships[i].path.length < relative.path.length) relative = relationships[i];
        }
        $('.primaryLink').attr("href","https://www.familysearch.org/tree/person/details/"+relative.id);

        // Show related Yeager (Steve or Jamie)
        if (relative.id == "245X-G1Z" || relative.id == "2H2N-9BL" || relative.id == "2HK1-C11") $('.steve').show();
        else $('.jamie').show();
        $('.download').show();
        $('.areyou').hide();
        $('#canvas').show();

        shareImg();
    }

    function shareImg() {
        // Generate sharable image
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var img1 = loadImage("https://api.familysearch.org/platform/tree/persons/"+fs.user.personId+"/portrait?access_token="+fs.accessToken, main);
        var img2 = loadImage('https://i.ibb.co/19QGzZ4/yeagers-blue.png', main);
        var imagesLoaded = 0;
        function main() {
            imagesLoaded += 1;
            if(imagesLoaded == 2) {
                ctx.drawImage(img2, 0, 0);
                ctx.drawImage(img1, 417, 33);
                // ctx.font = "25px Verdana";
                // ctx.fillStyle = "white";
                // ctx.fillText(fs.user.displayName, 400, 260);
            }
        }
    }

    // Load Image
    // http://www.thefutureoftheweb.com/blog/image-onload-isnt-being-called
    function loadImage(src, onload) {
        var img = new Image();
        img.onload = onload;
        img.crossOrigin = "anonymous";
        img.src = src;
        return img;
    }

    function download() {
		var link = document.createElement('a');
		link.download = 'soty.png';
		link.href = document.getElementById("canvas").toDataURL();
		link.click();
	}
</script>